// Generated by IcedCoffeeScript 1.7.1-b
var Automagic,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

Automagic = (function() {
  function Automagic() {}

  Automagic.prototype.initialize = function(options) {
    if (options == null) {
      options = {
        identify: {
          form_selector: 'form',
          property_map: {
            username: /.*username.*/,
            name: /.*name.*/,
            first_name: /.*first.*name.*/,
            last_name: /.*last.*name.*/,
            email: /.*email.*/,
            position: /.*position.*/,
            company: /.*company.*/,
            organization: /.*organi(z|s)ation.*/,
            industry: /.*industry.*/,
            location: /.*location.*/,
            latlng: /.*latl(ng|on).*/,
            birthday: /.*(birthday|dob|date.*of.*birth).*/
          },
          has_any_fields: ['username', 'name', 'first_name', 'last_name', 'email'],
          has_all_fields: []
        }
      };
    }
    this.form_selector = options.identify.form_selector;
    this.property_map = options.identify.property_map;
    this.has_any_fields = options.identify.has_any_fields;
    this.has_all_fields = options.identify.has_all_fields;
    return this.create_hooks();
  };

  Automagic.prototype.create_hooks = function() {
    var body, form, _i, _len, _ref;
    body = document.body || document.getElementByTagName('body')[0];
    body.setAttribute('data-automagic', '');
    _ref = document.querySelectorAll(this.form_selector);
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      form = _ref[_i];
      this.hook(form);
    }
    return this;
  };

  Automagic.prototype.hook = function(form) {
    var self;
    self = this;
    return $(form).submit(function(event) {
      var all_fields, any_fields, data, element, field;
      event.preventDefault();
      element = event.target;
      data = self.extract_data(element);
      all_fields = ((function() {
        var _i, _len, _ref, _results;
        _ref = self.has_all_fields;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          field = _ref[_i];
          if (__indexOf.call(data, field) >= 0) {
            _results.push(field);
          }
        }
        return _results;
      })()).size === self.has_all_fields.size;
      any_fields = ((function() {
        var _i, _len, _ref, _results;
        _ref = self.has_any_fields;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          field = _ref[_i];
          if (__indexOf.call(data, field) >= 0) {
            _results.push(field);
          }
        }
        return _results;
      })()).size >= 1;
      if (all_fields && any_fields) {
        if (trak && trak.io) {
          trak.io.identify(data);
        }
      }
      return $(this).off('submit').submit();
    });
  };

  Automagic.prototype.extract_data = function(element) {
    var data, elem, key, name, regex, value, _i, _len, _ref, _ref1;
    data = {};
    _ref = element.querySelectorAll('input, textarea');
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      elem = _ref[_i];
      name = elem.name;
      value = elem.value;
      _ref1 = this.property_map;
      for (key in _ref1) {
        regex = _ref1[key];
        if (regex.test(name)) {
          data[key] = value;
        }
      }
    }
    return data;
  };

  return Automagic;

})();

window.Automagic = Automagic;
